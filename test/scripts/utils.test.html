<html>
  <head>
    <script type="importmap">
      {
        "imports": {
          "https://main--milo--adobecom.hlx.live/libs/utils/utils.js": "./mocks/scripts-utils.js"
        }
      }
    </script>
    <meta name="publication-date" content="08-10-2023">
    <meta property="article:tag" content="Customer Intelligence">
    <meta property="article:tag" content="Customer Success">
  </head>
  <body></body>
  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { readFile } from '@web/test-runner-commands';
    import { expect } from '@esm-bundle/chai';
    import sinon from 'sinon';
    import waitForElement from '../helpers/waitForElement.js';
    import { setLibs, buildAutoBlocks } from '../../scripts/utils.js';

    runTests(() => {
      describe('Auto Blocks', () => {
        before(() => {
          setLibs('/libs');
        });

        beforeEach(() => {
          sinon.stub(console, 'error');
        });

        afterEach(() => {
          console.error.restore();
        });

        it('catches errors', async () => {
          document.body.innerHTML = '';
          await buildAutoBlocks();
          expect(console.error.calledWith('Auto Blocking failed')).to.be.true;
        });

        it('builds the tags block', async () => {
          document.body.innerHTML = await readFile({ path: './mocks/tagsBody.html' });
          await buildAutoBlocks();
          expect(document.querySelector('.tags')).to.exist;
        });

        it('inserts the tags block before recommended articles if present', async () => {
          document.body.innerHTML = await readFile({ path: './mocks/tagsWithRecBody.html' });
          await buildAutoBlocks();
          expect(document.querySelector('.tags + .recommended-articles')).to.exist;
        });

        it('inserts the tags block in section before recommended articles if present', async () => {
          document.body.innerHTML = await readFile({ path: './mocks/tagsWithRecSectionBody.html' });
          await buildAutoBlocks();
          expect(document.querySelector('.before-rec .tags')).to.exist;
        });

        it('builds the article header block', async () => {
          document.body.innerHTML = await readFile({ path: './mocks/articleHeaderBody.html' });
          await buildAutoBlocks();
          const articleHeader = await waitForElement('.article-header');
          expect(articleHeader).to.exist;
        });
      });
    });
  </script>
</html>
